# justfile - Modern command runner
# https://github.com/casey/just
#
# Install: cargo install just
# Usage: just <recipe>
# List: just --list

# Default recipe (shows help)
default:
    @just --list

# ============================================================================
# Development Workflows
# ============================================================================

# Build ReScript code
build:
    @echo "ðŸ”¨ Building ReScript â†’ JavaScript..."
    rescript build

# Build in watch mode
watch:
    @echo "ðŸ‘€ Watching ReScript files..."
    rescript build -w

# Clean build artifacts
clean:
    @echo "ðŸ§¹ Cleaning build artifacts..."
    rescript clean
    rm -rf lib/
    rm -rf **/*.bs.js
    rm -rf **/*.bs.mjs

# Run the application
run: build
    @echo "ðŸš€ Running application..."
    deno run --allow-net --allow-env --allow-read src/orchestrator/Index.bs.js

# Run in development mode with watch
dev:
    @echo "ðŸ”¥ Starting development server..."
    deno run --allow-net --allow-env --allow-read --watch src/orchestrator/Index.bs.js

# ============================================================================
# Testing
# ============================================================================

# Run all tests
test: build
    @echo "ðŸ§ª Running tests..."
    deno test --allow-net --allow-env --allow-read tests/

# Run tests with coverage
test-coverage: build
    @echo "ðŸ“Š Running tests with coverage..."
    deno test --allow-net --allow-env --allow-read --coverage=coverage/ tests/
    deno coverage coverage/

# Run specific test file
test-file FILE: build
    @echo "ðŸ§ª Running test: {{FILE}}"
    deno test --allow-net --allow-env --allow-read {{FILE}}

# ============================================================================
# Database Management
# ============================================================================

# Start databases (ArangoDB + Virtuoso)
db-up:
    @echo "ðŸ—„ï¸  Starting databases..."
    podman-compose up -d
    @echo "â³ Waiting for health checks..."
    @sleep 10
    @podman-compose ps

# Stop databases
db-down:
    @echo "ðŸ›‘ Stopping databases..."
    podman-compose down

# Reset databases (delete all data)
db-reset:
    @echo "â™»ï¸  Resetting databases (will delete all data)..."
    podman-compose down -v
    podman-compose up -d
    @sleep 10
    @echo "âœ“ Databases reset"

# Show database logs
db-logs SERVICE="":
    @if [ "{{SERVICE}}" = "" ]; then \
        podman-compose logs -f; \
    else \
        podman-compose logs -f {{SERVICE}}; \
    fi

# Check database health
db-health:
    @echo "ðŸ¥ Checking database health..."
    @podman-compose ps
    @echo "\nðŸ“Š ArangoDB:"
    @curl -s http://localhost:8529/_api/version || echo "âŒ Not responding"
    @echo "\nðŸ•¸ï¸  Virtuoso:"
    @curl -s http://localhost:8890/sparql || echo "âŒ Not responding"

# ============================================================================
# Code Quality
# ============================================================================

# Format code
fmt:
    @echo "âœ¨ Formatting code..."
    deno fmt
    @echo "âœ“ Deno files formatted"
    # ReScript formatter (if available)
    @command -v rescript-format >/dev/null && find src -name "*.res" -exec rescript-format -i {} \; || echo "âš ï¸  rescript-format not found"

# Lint code
lint:
    @echo "ðŸ” Linting code..."
    deno lint

# Type check
typecheck: build
    @echo "ðŸ”Ž Type checking..."
    @echo "âœ“ ReScript type checking done by compiler"
    @echo "Checking Rust..."
    cd src/core && cargo check

# Check all (fmt + lint + typecheck)
check: fmt lint typecheck
    @echo "âœ… All checks passed!"

# ============================================================================
# Rust/WASM
# ============================================================================

# Build Rust/WASM modules
wasm-build:
    @echo "ðŸ¦€ Building Rust â†’ WASM..."
    cd src/core && cargo build --target wasm32-unknown-unknown --release
    @echo "âœ“ WASM built: src/core/target/wasm32-unknown-unknown/release/*.wasm"

# Test Rust code
wasm-test:
    @echo "ðŸ§ª Testing Rust code..."
    cd src/core && cargo test

# Check Rust code
wasm-check:
    @echo "ðŸ” Checking Rust code..."
    cd src/core && cargo check
    cd src/core && cargo clippy -- -D warnings

# ============================================================================
# Julia Analytics
# ============================================================================

# Test Julia modules
julia-test:
    @echo "ðŸ§ª Testing Julia modules..."
    cd src/analytics && julia --project=. -e 'using Pkg; Pkg.test()'

# Run Julia script
julia-run SCRIPT:
    @echo "ðŸ“Š Running Julia script: {{SCRIPT}}"
    julia --project=src/analytics src/analytics/{{SCRIPT}}

# ============================================================================
# Documentation
# ============================================================================

# Generate UML diagrams (requires plantuml)
diagrams:
    @echo "ðŸ“ Generating UML diagrams..."
    @command -v plantuml >/dev/null || (echo "âŒ plantuml not found. Install: brew install plantuml"; exit 1)
    plantuml docs/diagrams/*.puml
    @echo "âœ“ Diagrams generated in docs/diagrams/"

# Serve documentation locally
docs-serve:
    @echo "ðŸ“š Serving documentation..."
    @command -v python3 >/dev/null && (cd docs && python3 -m http.server 8000) || \
     (command -v python >/dev/null && (cd docs && python -m SimpleHTTPServer 8000)) || \
     echo "âŒ Python not found for serving docs"

# ============================================================================
# RSR Compliance
# ============================================================================

# Verify RSR compliance
rsr-verify:
    @echo "âœ… Verifying RSR (Rhodium Standard Repository) compliance..."
    @echo ""
    @echo "ðŸ“‹ Documentation:"
    @test -f README.md && echo "  âœ“ README.md" || echo "  âŒ README.md"
    @test -f LICENSE && echo "  âœ“ LICENSE" || echo "  âŒ LICENSE"
    @test -f SECURITY.md && echo "  âœ“ SECURITY.md" || echo "  âŒ SECURITY.md"
    @test -f CODE_OF_CONDUCT.md && echo "  âœ“ CODE_OF_CONDUCT.md" || echo "  âŒ CODE_OF_CONDUCT.md"
    @test -f CONTRIBUTING.md && echo "  âœ“ CONTRIBUTING.md" || echo "  âŒ CONTRIBUTING.md"
    @test -f MAINTAINERS.md && echo "  âœ“ MAINTAINERS.md" || echo "  âŒ MAINTAINERS.md"
    @test -f CHANGELOG.md && echo "  âœ“ CHANGELOG.md" || echo "  âŒ CHANGELOG.md"
    @echo ""
    @echo "ðŸŒ .well-known/:"
    @test -f .well-known/security.txt && echo "  âœ“ security.txt (RFC 9116)" || echo "  âŒ security.txt"
    @test -f .well-known/ai.txt && echo "  âœ“ ai.txt (AI training policy)" || echo "  âŒ ai.txt"
    @test -f .well-known/humans.txt && echo "  âœ“ humans.txt (attribution)" || echo "  âŒ humans.txt"
    @echo ""
    @echo "ðŸ”§ Build System:"
    @test -f justfile && echo "  âœ“ justfile (task runner)" || echo "  âŒ justfile"
    @test -f deno.json && echo "  âœ“ deno.json (Deno config)" || echo "  âŒ deno.json"
    @test -f bsconfig.json && echo "  âœ“ bsconfig.json (ReScript)" || echo "  âŒ bsconfig.json"
    @test -f compose.yml && echo "  âœ“ compose.yml" || echo "  âŒ compose.yml"
    @test -f .gitlab-ci.yml && echo "  âœ“ .gitlab-ci.yml (CI/CD)" || echo "  âš ï¸  .gitlab-ci.yml (optional)"
    @test -f flake.nix && echo "  âœ“ flake.nix (Nix builds)" || echo "  âš ï¸  flake.nix (optional)"
    @echo ""
    @echo "ðŸ”’ Security:"
    @echo "  âœ“ ReScript (sound types, no null/undefined)"
    @echo "  âœ“ Deno (explicit permissions)"
    @test -f src/core/Cargo.toml && echo "  âœ“ Rust/WASM (memory safety)" || echo "  âš ï¸  Rust/WASM"
    @echo ""
    @echo "ðŸ“¦ Offline-First:"
    @echo "  âœ“ No required network calls in core"
    @echo "  âœ“ Local database instances"
    @echo "  âœ“ Air-gap capable"
    @echo ""
    @echo "ðŸ§ª Testing:"
    @test -d tests && echo "  âœ“ Test directory exists" || echo "  âŒ tests/"
    @echo ""
    @echo "ðŸŽ¯ TPCF Perimeter:"
    @echo "  âœ“ Perimeter 3: Community Sandbox (Open Source)"
    @echo ""
    @echo "ðŸ“Š RSR Compliance Level: BRONZE"

# Full validation (all checks + tests)
validate: check rsr-verify test
    @echo ""
    @echo "ðŸŽ‰ Full validation complete!"

# ============================================================================
# Git Workflows
# ============================================================================

# Show git status
status:
    @git status

# Create a new feature branch
branch NAME:
    @echo "ðŸŒ¿ Creating branch: {{NAME}}"
    git checkout -b feature/{{NAME}}

# Quick commit and push
commit MSG:
    @echo "ðŸ’¾ Committing: {{MSG}}"
    git add -A
    git commit -m "{{MSG}}"
    git push

# ============================================================================
# Release Management
# ============================================================================

# Create a new release
release VERSION:
    @echo "ðŸš€ Creating release: v{{VERSION}}"
    @echo "Updating CHANGELOG.md..."
    @echo "\n## [{{VERSION}}] - $(date +%Y-%m-%d)" >> CHANGELOG.md
    git add CHANGELOG.md
    git commit -m "Release v{{VERSION}}"
    git tag -a v{{VERSION}} -m "Release v{{VERSION}}"
    @echo "âœ“ Tagged v{{VERSION}}"
    @echo "Push with: git push && git push --tags"

# ============================================================================
# Utilities
# ============================================================================

# Show project statistics
stats:
    @echo "ðŸ“Š Project Statistics"
    @echo "===================="
    @echo "Lines of Code:"
    @find src -name "*.res" -o -name "*.rs" -o -name "*.jl" | xargs wc -l | tail -1
    @echo "\nFiles:"
    @find src -type f | wc -l
    @echo "\nLanguages:"
    @echo "  - ReScript: $(find src -name "*.res" | wc -l) files"
    @echo "  - Rust: $(find src -name "*.rs" | wc -l) files"
    @echo "  - Julia: $(find src -name "*.jl" | wc -l) files"
    @echo "\nDependencies:"
    @echo "  - Deno imports: $(grep -c '"' deno.json || echo 0)"
    @echo "  - Rust crates: $(grep -c 'dependencies' src/core/Cargo.toml 2>/dev/null || echo 0)"

# Clean everything (build artifacts + databases)
nuke: clean db-down
    @echo "ðŸ’¥ Nuclear clean - removing all generated files and containers..."
    rm -rf coverage/
    rm -rf .deno/
    podman-compose down -v
    @echo "âœ“ Everything cleaned!"

# Show system information
info:
    @echo "ðŸ”§ System Information"
    @echo "===================="
    @echo "Deno: $(deno --version | head -1)"
    @echo "ReScript: $(rescript -version)"
    @command -v cargo >/dev/null && echo "Rust: $(rustc --version)" || echo "Rust: not installed"
    @command -v julia >/dev/null && echo "Julia: $(julia --version)" || echo "Julia: not installed"
    @echo "Podman: $(podman --version)"
    @echo "Just: $(just --version)"

# ============================================================================
# Help
# ============================================================================

# Show this help message
help:
    @just --list

# Show detailed help for a recipe
help-recipe RECIPE:
    @just --show {{RECIPE}}
